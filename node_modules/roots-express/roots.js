var path = require('path'),
    watcher = require('./watcher'),
    roots_css = require('roots-css'),
    WebSocket = require('faye-websocket'),
    ws;


// @api public
// - sets up the live reload server and file watcher
// - adds roots-css middleware
// - adds coffeescript

exports.init = function(app, server){
  // add coffeescript
  // require('coffee-script');

  // start the file watcher
  var views = path.join(__dirname, '../..', 'views');
  var assets = path.join(__dirname, '../..', 'public');
  watcher.watchDirectories([views, assets], function(){
    ws && ws.send('reload');
  });

  // set up websockets
  server.addListener('upgrade', function(request, socket, head) {
    ws = new WebSocket(request, socket, head);
    ws.onopen = function(){ ws.send('connected'); }
  });

  // middleware to inject socket code function

  // add roots-css

  function compile(str, path) {
    return stylus(str).set('filename', path).use(roots_ css());
  }

  app.configure(function(){
    app.use(require('stylus').middleware({ src: __dirname + '/public', compile: compile }));
  });

}